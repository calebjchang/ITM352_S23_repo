<!DOCTYPE html>
<html lang="en">
    <!--Created by Caleb Chang-->
    <!--Page Containing a simple webstore displaying products and prints invoice when purchase is completed-->
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width ,initial-scale=1.0">
    <title>Smartphone Products</title>
    <link rel="stylesheet" type="text/css" href="products-style.css">
    <script src="./products.js" type="text/javascript">
    </script>
    <!--Background Video
    <video autoplay muted loop id="myVideo">
        <source src="/Images/NJ_bg2023_24fps.mp4" type="video/mp4">
    </video>
-->
    <script>

// Created function used to check input in the textbox
// Used ChatGPT to tweak the function to dynamically change my error message, as well as match IR3's criteria
function checkQuantityTextbox(qtyTextbox) {
   const qtyAva = parseInt(qtyTextbox.dataset.qtyAva); // Get available quantity from dataset
   const qty = parseInt(qtyTextbox.value); // Get entered quantity
   const errorSpan = document.getElementById(qtyTextbox.id + "_errors");
   // Check if entered quantity exceeds available quantity
   if (qty > qtyAva) { 
    // Changes the error message to the following
     errorSpan.innerHTML = `We don't have ${qty} available`;
     // Sets textbox value to available quantity
     qtyTextbox.value = qtyAva; 
     // Changes textbox border color to red when value is > qtyAva
     qtyTextbox.style.borderColor = "red"; 
   } 
   // Clears error message and changes border color back to default
   else { 
     errorSpan.innerHTML = "";
     qtyTextbox.style.borderColor = "";
   }
};
//Help form Daniel Port on alert message section
const params = (new URL(document.location)).searchParams;
//creating function for use in window onload
function alertmessage (){
    var submit_button_msg = "";
   for (let i in products) {
    //if I have the quantity data then put back into textboxes
    if (params.has('quantity'+i)) {
        purchase_form['quantity'+i].value = params.get('quantity'+i);
        //Checking if quantity error exists and if so then displaying under text box in red
        if (params.has('quantity_error'+i)) {
            purchase_button.value = "Select valid quantities!";
            purchase_button.style.color = "red";
            document.getElementById(`quantity${i}_errors`).innerHTML = `<font style="color:red">${params.get('quantity_error'+i)}</font>`;
        }   
        //Checking if stock error exists and if so then displaying under text box in red
        else if (params.has('stock_outage' + i)) {
            purchase_button.value = "Please only select quantities that are in stock!";
            purchase_button.style.color = "red";
            document.getElementById(`quantity${i}_errors`).innerHTML = `<font style="color:red">${params.get('stock_outage' + i)}</font>`;
        }
        
    }
}
   }
//If there are no inputs in textboxes, display the no selections error in the button. In addition, other errors will display in the button using the submit_button_msg error.
   if (params.has('no_selections_error')) {
    submit_button_msg = params.get('no_selections_error');
   }
   
    
//On window load, carry out the alertmessage function. Doing this on window onload so textboaxes are loaded in already and have space for errors. 
 window.onload = alertmessage; 
    </script>
</head>
<!-- Form to POST to the server -->
<form name = "purchase_form" action = "/purchase" method = "post">
<body>
    <h1>welcome to newjeans.store!</h1>
    <div><main>
<!-- Product information loop -->
<!-- Input section based on help from ChatGPT-->
<script>
for (i = 0; i < products.length; i++) {
    document.write(`
    <section class="item">
        <h2>${products[i].name}</h2>
        <p>$${products[i].price}.00</p>
        <img src = ${products[i].image}>
        <p>Quantity Available: ${products[i].qty_ava}</p>
        <p><label id = "quantity${i}_label">Quantity Desired</label></p>
        <input value = "0" type = "text" name = "quantity${i}" id = "quantity${i}" data-qty-ava="${products[i].qty_ava}" onkeyup = "checkQuantityTextbox(this)">
        <p id = "quantity${i}_errors"></p>
    </section>`)
};
    console.log(params);
</script>
    
</main></div>
<h1>Your One Stop NewJeans Shop!</h1>
<!-- Purchase button here-->
<footer>
    <input id="purchase_button" type="submit" value="Purchase" name="purchase_submit">
    <script> 
        purchase_button.value = submit_button_msg;
        purchase_button.style.color = "red";
    </script>
</footer>
</body>
</form>
</html>